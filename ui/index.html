<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Website</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/bible.css">
</head>
<body>
    <header>
        <div class="dropdown">
            <button class="dropdown-btn" id="books-btn">Books</button>
            <div class="dropdown-content" id="books-dropdown"></div>
        </div>
        <div class="dropdown">
            <button class="dropdown-btn" id="chapters-btn">Chapters</button>
            <div class="dropdown-content" id="chapters-dropdown"></div>
        </div>
        <div class="image-btn" id="highlight-btn">
            <input type="image" src="images/light-paintbrush-pencil.svg"/>
        </div>
        <div class="image-btn" id="highlight-settings">
            <input type="image" src="images/light-plus.svg"/>
        </div>
    </header>
    <main>
        <section class="content">
            <div class="bible-text">
                <div id="chapter-content"></div>
        </section>
    </main>
    <script type="module">
        import { debug_print, invoke } from './src/utils.js';
        import * as bible from './src/bible.js';

        document.getElementById('highlight-settings').addEventListener('click', (_) => {
            window.location.href = "highlight_editor.html";
        });

        bible.get_chapter().then((chapter) => {
            bible.load_view().then((view) => {
                document.getElementById('books-btn').innerHTML = view[chapter.book].name;
                document.getElementById('chapters-btn').innerHTML = `${chapter.number + 1}`;
            })
        });

        bible.create_books_selection();
        bible.create_chapter_selection();

        bible.render_current_chapter().then((content) => {
            document.getElementById('chapter-content').innerHTML = content;
        }).then(() => {
            let isHighting = false;
            let isDragging = false;
            let startElement = null;
            let endElement = null;

            document.getElementById('highlight-btn').addEventListener('click', (event) => {
                isHighting = true;
                startElement = null;
                endElement = null;
                document.getElementById('highlight-btn').classList.add('toggled-btn');
            })

            let wordDivs = document.getElementsByClassName('bible-word');

            for (let i = 0; i < wordDivs.length; i++)
            {
                let div = wordDivs[i];
                div.addEventListener('mousedown', (event) => {
                    if (isHighting)
                    {
                        isDragging = true;
                        for (let j = 0; j < wordDivs.length; j++)
                        {
                            wordDivs[j].classList.remove('selected');   
                        }   
                        startElement = event.target;
                        endElement = event.target;
                        selectRange(startElement, endElement);
                    }
                });

                div.addEventListener('mouseover', (event) => {
                    if (isDragging) {
                        endElement = event.target;
                        for (let j = 0; j < wordDivs.length; j++)
                        {
                            wordDivs[j].classList.remove('selected');   
                        }
                        selectRange(startElement, endElement);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (!isHighting) { return; }
                    document.getElementById('highlight-btn').classList.remove('toggled-btn');
                    isDragging = false;
                    isHighting = false;

                    for (let j = 0; j < wordDivs.length; j++)
                    {
                        wordDivs[j].classList.remove('selected');   
                    }
                    
                    let start_idx = -1;
                    for (let i = 0; i < wordDivs.length; i++)
                    {
                        let word = wordDivs[i];
                        if (word === startElement) 
                        { 
                            start_idx = i;
                            break;
                        }
                    }

                    let end_idx = -1;
                    for (let i = 0; i < wordDivs.length; i++)
                    {
                        let word = wordDivs[i];
                        if (word === endElement)
                        {   
                            end_idx = i;
                            break;    
                        }
                    }

                    if (start_idx > -1 && end_idx > -1)
                    {
                        bible.get_chapter_view().then((view) => {
                            let start = bible.get_word_index(start_idx, view);
                            let end = bible.get_word_index(end_idx, view);

                            invoke('add_note', { start: JSON.stringify(start), end: JSON.stringify(end) }).then((_) => {
                                location.reload();
                            });
                        })
                    }
                });
            };

            function selectRange(start, end) {
                let selecting = false;
                for (let i = 0; i < wordDivs.length; i++)
                {
                    let div = wordDivs[i];
                    if (div === start && div === end)
                    {
                        div.classList.add('selected');
                        break;
                    }
                    if (div === start || div === end) 
                    {
                        selecting = !selecting;
                        div.classList.add('selected');
                    } 
                    else if (selecting) 
                    {
                        div.classList.add('selected');
                    }   
                }
            }
        });
    </script>
</body>
</html>
